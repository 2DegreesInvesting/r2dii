---
title: "Computational document with parameters"
params:
  loanbook: "~/Downloads/data/from-bank/loanbook.csv"
  abcd: "~/Downloads/data/from-2dii/abcd.csv"
  scenario: "~/Downloads/data/from-2dii/scenario.csv"
  regions: "~/Downloads/data/from-2dii/regions.csv"
  to_validate: "~/Downloads/data/validation/to_validate.csv"
  validated: "~/Downloads/data/validation/validated.csv"
  sector: "oil and gas"
  show_code: FALSE
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  # cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  warning = FALSE,
  message = FALSE
)

options(readr.show_col_types = FALSE)
show_code <- params$show_code
```

Because tilt's software is in development, we still can't show its workflow from
end to end. But tilt's software is very similar to [r2dii's
software](https://pacta.rmi.org/pacta-for-banks-2020/), which is mature, and was
originally developed by 2DII. Therefore this article shows the r2dii workflow
instead.

The r2dii workflow involves multiple software components. For every use case,
there are multiple ways to combine those multiple components. A fairly direct
and interactive way is via a parametrized computational document like the one
you're reading. We type the code for you, and you change parameters using an
widget.

This workflow is run by a bank, entirely in its machine. It uses one dataset of
its own, plus some datasets from the r2dii team.

```{r echo=show_code}
# r2dii software
# * Toy data from banks and from tilt data-management. Eventually tiltToyData.
library(r2dii.data)
# * Like tilt.company.match, eventually tiltMatch
library(r2dii.match)
# * Like tiltIndicator
library(r2dii.analysis)
# * Like tiltPlot
library(r2dii.plot)

# General software
library(tidyverse, warn.conflicts = FALSE)
```

### Match

```{r echo=show_code}
# Private data from the bank
loanbook <- read_csv(params$loanbook)
# Asset-level data from the r2dii team
abcd <- read_csv(params$abcd)

matched <- match_name(loanbook, abcd)
```

```{r}
matched
```

### Validate and prioritize matching companies

* The bank saves the matched dataset to validate it manually.

```{r echo=show_code}
write_csv(matched, params$to_validate)
```

* The bank validates the matches manually, then reads the validated dataset.

```{r echo=show_code}
validated <- read_csv(params$validated)
```

* Where the number of perfect matches is greater than one, [pick the one with highest priority](https://rmi-pacta.github.io/r2dii.match/reference/prioritize.html).

```{r echo=show_code}
validated_and_prioritized <- prioritize(validated)
```

```{r}
validated_and_prioritized
```

### Calculate metrics using 2DII methodology

calculate scenario targets for the `production` of a technology in a sector, at the portfolio level using the [Market Share Approach](https://rmi-pacta.github.io/r2dii.analysis/articles/target-market-share.html).

```{r echo=show_code}
# Datasets that the bank gets from a data provider
scenario <- read_csv(params$scenario)
regions <- read_csv(params$regions)

metric <- validated_and_prioritized |>
  target_market_share(abcd = abcd, scenario = scenario, region_isos = regions)
```

```{r}
metric
```

### The bank visualizes the calculated metric

Visualize the portfolio's exposure to various climate sensitive technologies
(`projected`), and compare with the corporate economy, or against various
scenario targets.

```{r echo=show_code}
# Pick the targets you want to plot
picked <- filter(
  metric,
  scenario_source == "demo_2020",
  sector == params$sector,
  region == "global",
  metric %in% c("projected", "corporate_economy", "target_sds")
)

# Plot the technology mix
qplot_techmix(picked)
```

---
title: "Demo"
output: 
  flexdashboard::flex_dashboard:
    source_code: embed
    storyboard: true
    theme: flatly
params:
  loanbook: "~/Downloads/data/from-bank/loanbook.csv"
  abcd: "~/Downloads/data/from-2dii/abcd.csv"
  scenario: "~/Downloads/data/from-2dii/scenario.csv"
  regions: "~/Downloads/data/from-2dii/regions.csv"
  to_validate: "~/Downloads/data/validation/to_validate.csv"
  validated: "~/Downloads/data/validation/validated.csv"
  sector: "oil and gas"
---

```{r setup, include=FALSE}
library(flexdashboard)

options(readr.show_col_types = FALSE)
show_code <- FALSE
```

# Why r2dii?

Because tilt's software is still in development, we can't show its workflow from
end to end. But tilt's software is very similar to [r2dii's
software](https://pacta.rmi.org/pacta-for-banks-2020/), so we'll show it
instead.

The workflows for tilt and r2dii differ only in details -- in the specific type
of data and methodology. But at the core, they share the main steps:

1. Match bank's data with 2DII's data.
2. Validate those matches manually.
3. Analyze the data based on 2DII's methodology.
4. Visualize the results.

```{r echo=show_code}
# r2dii software
# * Toy data from banks and from tilt data-management. Eventually tiltToyData.
library(r2dii.data)
# * Like tilt.company.match, eventually tiltMatch
library(r2dii.match)
# * Like tiltIndicator
library(r2dii.analysis)
# * Like tiltPlot
library(r2dii.plot)

# General software
library(tidyverse, warn.conflicts = FALSE)
library(DT)
```

# Workflow {.storyboard}

### **Loanbook dataset:** This is one of the two inputs to the matching process.

```{r echo=show_code}
loanbook <- read_csv(params$loanbook)
```

```{r}
datatable(loanbook)
```

*** 

The bank structures this dataset following 2DII guidelines. This is similar to the dataset that banks need to work with tilt.

### **Companies dataset:** This is the second input to the matching process, and aso an input to the analysis process that comes later.

```{r echo=show_code}
abcd <- read_csv(params$abcd)
```

```{r}
datatable(abcd)
```

*** 

This is similar to the companies dataset that tilt produces and shares with banks.

Banks get this dataset from 2DII or a comercial provider of 2DII-compatible
data.

### **Matched dataset:** This is the output of the matching process, and the input to the manual validation process that follows.

```{r echo=show_code}
matched <- match_name(loanbook, abcd)
```

```{r}
datatable(matched)
```

***

This is similar to the output of
[tilt.company.match](https://2degreesinvesting.github.io/tilt.company.match/)
which some banks already experienced in an early road testing. The bank saves
this dataset to validate it manually with a spreadsheet editor like MS Excel.

### **Validated dataset:** This is the result of the manual validation. It is one input to the analysis process that follows.

```{r echo=show_code}
# The bank saves the matched data to validate it manually.
write_csv(matched, params$to_validate)
```

```{r echo=show_code}
validated <- read_csv(params$validated)
```

```{r echo=show_code}
# Where the number of perfect matches is greater than one, pick the one with
# highest priority
validated_and_prioritized <- prioritize(validated)
```

```{r}
datatable(validated_and_prioritized)
```

*** 

The previous step and this one are interrupted. For large loanbooks banks
typically take several days to produce this dataset. Once done this step reads
it in and the workflow continues.

### **Scenarios dataset:** This is also an input to the analysis process.

```{r echo=show_code}
# Datasets that the bank gets from a data provider
scenario <- read_csv(params$scenario)
```

```{r}
datatable(scenario)
```

***

Banks get this dataset from 2DII or a comercial provider of 2DII-compatible
data.

### **Regions dataset:** This is yet another input to the analysis process.

```{r echo=show_code}
# Datasets that the bank gets from a data provider
regions <- read_csv(params$regions)
```

```{r}
datatable(regions)
```

***

Banks get this dataset from 2DII or a comercial provider of 2DII-compatible
data.

### **Analyzed dataset:** This is the output of the analysis process. It involves running sofware that implements 2DII's methodology.

```{r echo=show_code}
regions <- read_csv(params$regions)

metric <- validated_and_prioritized |>
  target_market_share(abcd = abcd, scenario = scenario, region_isos = regions)
```

```{r}
datatable(metric)
```

*** 

This is similar to the output of [tiltIndicator](https://2degreesinvesting.github.io/tiltIndicator/).

### **Visualization:** This is one of several visualizations possible.

```{r echo=show_code}
# Pick the targets you want to plot
picked <- filter(
  metric,
  scenario_source == "demo_2020",
  sector == params$sector,
  region == "global",
  metric %in% c("projected", "corporate_economy", "target_sds")
)
```

```{r}
# Plot the technology mix
qplot_techmix(picked)
```

*** 

This is similar to the output of [tiltPlot](https://2degreesinvesting.github.io/tiltPlot/).
